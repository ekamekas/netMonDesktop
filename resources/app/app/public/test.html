<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Test Pengelompokan</title>
    <script type="text/javascript" src="../js/dataStatistic.js">
    </script>
    <script type="text/javascript" src="../js/utility.js">
    </script>
    <script type="text/javascript" src="../js/plotly-latest.min.js">
    </script>
  </head>
  <body>
    URI:
    <input id="api_host" type="text" name="" value="https://123.231.138.149/api/historicdata.xml?" />
    <br>
    dateFrom:
    <input id="api_date_from" type="text" placeholder="API" value="2017-06-01-00-00-00"/>
    <br>
    dateto
    <input id="api_date_to" type="text" placeholder="API" value="2017-06-30-00-00-00"/>
    <br>
    Sensor:
    <input id="api_sensor" type="text" placeholder="API" value="11734"/><br>
    Interval:
    <input id="api_interval" type="text" placeholder="API" value=60 />
    (minutes)<br>
    <button id="api_button" type="button" name="button">Process</button>
    <br>
    <p><a href="../../index.html">Home</a></p>
    <div id="graph_1" style="width:600px;height:250px;">
    </div>
    <div id="graph_2" style="width:600px;height:250px;">
    </div>
    <p id="result"></p>
    <script type="text/javascript">
    var trafficData = []
    var sortedData = []
    var peaks = []
    var clusters = []
    var sortedPeaks = []
    var clustersOfPeaks = []

    const USERNAME = "nsc_admin"
    const PASSHASH = "4041964660"
    document.getElementById("api_button").onclick = function(){
      new Utility().getXML(document.getElementById("api_host").value.toString() + "sdate=" + document.getElementById("api_date_from").value.toString() + "&edate=" + document.getElementById("api_date_to").value.toString() + "&id=" + document.getElementById("api_sensor").value.toString() + "&avg=" + (document.getElementById("api_interval").value * 60).toString() + "&username=" + USERNAME + "&passhash=" + PASSHASH, function(result){

        trafficData = []
        sortedData = []
        for(let i = 1; i < result.histdata.item.length; i++){
          trafficData.push(parseInt(result.histdata.item[i].value_raw[1]._/125))
          sortedData.push(parseInt(result.histdata.item[i].value_raw[1]._/125))
        }
        peaks = findPeaks(trafficData)
        sortedPeaks = findPeaks(trafficData)
        new DataStatistic().sortedData(sortedData)
        new DataStatistic().sortedData(sortedPeaks)
        console.log(new DataStatistic().percentil(95, sortedData))
        let widthClass = Math.ceil((sortedData[sortedData.length - 1] - sortedData[0])/(1 + 3.3 * Math.log(sortedData.length)))
        clusters = new DataCluster(sortedData, widthClass)
        clusterOfPeaks = new DataCluster(sortedPeaks, Math.ceil((sortedPeaks[sortedPeaks.length - 1] - sortedData[0])/(1 + 3.3 * Math.log(sortedPeaks.length))))

        peak_95e = new DataStatistic().percentil(95, peaks)

        console.log(clusterOfPeaks)

        // Plot data
        var layout = {
          title: 'Estimation peak bandwidth',
          yaxis: {
            title: 'Speed (Kbps)',
            titlefont: {
              family: 'Courier New, monospace',
              size: 18,
              color: '#7f7f7f'
            }
          }
        };
        let data = {
          x: [],
          y: [],
          name: "data"
        };
        let estimasi = {
          x: [0, sortedData.length],
          y: [peak_95e, peak_95e],
          name: "estimation"
        };
        for(let i = 1; i <= trafficData.length; i++){
          data.x.push(i)
        }
        data.y = trafficData
        Plotly.newPlot(document.getElementById('graph_1'), [data, estimasi], {
           margin: { t: 0 },
           title: "Bandwidth"
        })
        data.y = sortedData
        Plotly.newPlot(document.getElementById('graph_2'), [data, estimasi], {
           margin: { t: 0 },
           title: "Bandwidth"
        })
        document.getElementById("result").innerHTML = '<p>95e Peak : ' + peak_95e + ' Kbps</p><p>Max : ' + sortedData[sortedData.length - 1] + ' Kbps</p><p>min : ' + sortedData[0] + ' Kbps</p>'

        // document.getElementById("result").appendChild(document.createTextNode("95 persentil : " + peak_95e + " Kbps"))
        // document.getElementById("result").appendChild(document.createElement('p')).appendChild(document.createTextNode("Max : " + sortedData[sortedData.length - 1] + " Kbps"))
        // document.getElementById("result").appendChild(document.createElement('p')).appendChild(document.createTextNode("min : " + sortedData[0] + " Kbps"))

      })
    }

    var findPeaks = (array) => {
      let peaks = []
      for(let i = 0; i < array.length; i++){
        if(array[i] > array[i + 1])
          peaks.push(array[i])
      }
      return peaks
    }
    </script>
  </body>
</html>
